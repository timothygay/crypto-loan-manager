<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crypto Prime Broker</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;700&family=DM+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * { font-family: 'DM Sans', sans-serif; }
        .mono { font-family: 'JetBrains Mono', monospace; }
        .tab-active { border-bottom: 2px solid #22d3ee; color: #22d3ee; }
        .tab-inactive { border-bottom: 2px solid transparent; color: #94a3b8; }
        .tab-inactive:hover { color: #cbd5e1; border-bottom-color: #475569; }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
        input[type="number"]::-webkit-inner-spin-button { opacity: 0.5; }
        .price-flash { animation: flash 0.6s ease; }
        @keyframes flash { 0%,100% { opacity:1; } 50% { opacity:0.4; } }
        .badge-active { background: rgba(34,197,94,0.15); color: #4ade80; border: 1px solid rgba(34,197,94,0.3); }
        .badge-matured { background: rgba(59,130,246,0.15); color: #60a5fa; border: 1px solid rgba(59,130,246,0.3); }
        .badge-invested { background: rgba(245,158,11,0.15); color: #fbbf24; border: 1px solid rgba(245,158,11,0.3); }
        .badge-repaid { background: rgba(148,163,184,0.15); color: #94a3b8; border: 1px solid rgba(148,163,184,0.3); }
        .trigger-row { background: rgba(239,68,68,0.08); }
        .profit { color: #4ade80; }
        .loss { color: #f87171; }
        .card { background: rgba(15,23,42,0.6); border: 1px solid rgba(51,65,85,0.8); border-radius: 12px; }
        .card-inner { background: rgba(15,23,42,0.8); border: 1px solid rgba(51,65,85,0.5); border-radius: 8px; }
        .gradient-text { background: linear-gradient(135deg, #38bdf8, #22d3ee, #34d399); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
        .btn-primary { background: linear-gradient(135deg, #0ea5e9, #06b6d4); transition: all 0.2s; }
        .btn-primary:hover { background: linear-gradient(135deg, #0284c7, #0891b2); transform: translateY(-1px); box-shadow: 0 4px 12px rgba(6,182,212,0.3); }
        .btn-secondary { background: rgba(51,65,85,0.8); border: 1px solid rgba(71,85,105,0.8); transition: all 0.2s; }
        .btn-secondary:hover { background: rgba(71,85,105,0.8); }
        .spinning { animation: spin 1s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .table-row-hover:hover { background: rgba(51,65,85,0.3); cursor: pointer; }
        .drill-back { color: #22d3ee; cursor: pointer; }
        .drill-back:hover { color: #67e8f9; }
        .fully-invested-glow { box-shadow: 0 0 20px rgba(245,158,11,0.2); border-color: rgba(245,158,11,0.4) !important; }
    </style>
</head>
<body class="bg-slate-950 text-white min-h-screen">
<div id="root"></div>
<script type="text/babel">
const { useState, useEffect, useRef, useCallback, useMemo } = React;

// ─── SHARED UTILS ─────────────────────────────────────────────────────────────
const fmt = (n, d=2) => (n||0).toLocaleString('en-US', {minimumFractionDigits:d, maximumFractionDigits:d});
const fmtCrypto = (n, d=8) => (n||0).toLocaleString('en-US', {minimumFractionDigits:2, maximumFractionDigits:d});
const fmtDate = (s) => {
    if (!s) return '';
    const d = new Date(s);
    const months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
    return `${d.getUTCDate()}-${months[d.getUTCMonth()]}-${d.getUTCFullYear()}`;
};
const fmtDateTimeSGT = (iso) => {
    if (!iso) return '';
    return new Date(iso).toLocaleString('en-SG', {timeZone:'Asia/Singapore',day:'2-digit',month:'short',year:'numeric',hour:'2-digit',minute:'2-digit',hour12:false});
};

// ─── ICONS ────────────────────────────────────────────────────────────────────
const Icon = {
    Plus: () => <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M5 12h14M12 5v14"/></svg>,
    Edit: () => <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/></svg>,
    Trash: () => <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>,
    Refresh: ({spin}) => <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" className={spin?'spinning':''}><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/><path d="M8 16H3v5"/></svg>,
    Download: () => <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></svg>,
    Upload: () => <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" x2="12" y1="3" y2="15"/></svg>,
    Settings: () => <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="12" cy="12" r="3"/><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 1 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.5a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/></svg>,
    ChevronLeft: () => <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="m15 18-6-6 6-6"/></svg>,
    ChevronRight: () => <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="m9 18 6-6-6-6"/></svg>,
    AlertTriangle: () => <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><path d="M12 9v4"/><path d="M12 17h.01"/></svg>,
    Lock: () => <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><rect width="18" height="11" x="3" y="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>,
    TrendingUp: () => <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="22 7 13.5 15.5 8.5 10.5 2 17"/><polyline points="16 7 22 7 22 13"/></svg>,
    X: () => <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>,
    Check: () => <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M20 6 9 17l-5-5"/></svg>,
    Dollar: () => <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="12" x2="12" y1="2" y2="22"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>,
};

// ─── SHARED FORM FIELD ────────────────────────────────────────────────────────
const Field = ({label, hint, children}) => (
    <div>
        <label className="block text-xs font-medium text-slate-400 mb-1.5">{label}</label>
        {children}
        {hint && <p className="text-xs text-slate-500 mt-1">{hint}</p>}
    </div>
);

const Input = (props) => (
    <input {...props} className={`w-full px-3 py-2 bg-slate-800 rounded-lg border border-slate-700 focus:border-cyan-500 focus:outline-none text-white text-sm mono ${props.className||''}`} />
);

const Select = ({children, ...props}) => (
    <select {...props} className="w-full px-3 py-2 bg-slate-800 rounded-lg border border-slate-700 focus:border-cyan-500 focus:outline-none text-white text-sm">
        {children}
    </select>
);

// ─── PRICE TICKER ─────────────────────────────────────────────────────────────
const PriceTicker = ({prices, fetchingPrices, onRefresh}) => (
    <div className="grid grid-cols-2 gap-3 mb-6">
        {[['BTC','₿','orange'],['ETH','Ξ','purple']].map(([sym,icon,c]) => (
            <div key={sym} className={`card p-4 bg-gradient-to-br from-${c}-500/10 to-${c}-600/5 border-${c}-500/20`}>
                <div className="flex items-center justify-between">
                    <div>
                        <p className="text-xs text-slate-400">{sym === 'BTC' ? 'Bitcoin' : 'Ethereum'}</p>
                        <p className={`text-2xl font-bold mono ${fetchingPrices ? 'opacity-50' : ''}`}>${fmt(prices[sym], 0)}</p>
                        <p className="text-xs text-slate-500 mt-0.5">Live · USDT</p>
                    </div>
                    <div className={`text-3xl text-${c}-400 opacity-60`}>{icon}</div>
                </div>
            </div>
        ))}
    </div>
);

// ═══════════════════════════════════════════════════════════════════════════════
// LOAN MANAGEMENT MODULE (ported from original, minimal changes)
// ═══════════════════════════════════════════════════════════════════════════════
const LoanModule = ({prices}) => {
    const [loans, setLoans] = useState(() => { try { return JSON.parse(localStorage.getItem('cpb_loans')||'[]'); } catch { return []; } });
    const [transactions, setTransactions] = useState(() => { try { return JSON.parse(localStorage.getItem('cpb_transactions')||'[]'); } catch { return []; } });
    const [config, setConfig] = useState(() => { try { return JSON.parse(localStorage.getItem('cpb_loan_config')||'{}'); } catch { return {}; } });
    const [showAdd, setShowAdd] = useState(false);
    const [editingLoan, setEditingLoan] = useState(null);
    const [showSettings, setShowSettings] = useState(false);
    const [showTxn, setShowTxn] = useState(null);
    const [loading, setLoading] = useState(false);
    const [lastSync, setLastSync] = useState(null);
    const [filterStatus, setFilterStatus] = useState('all');
    const [sortBy, setSortBy] = useState('default');

    useEffect(() => { localStorage.setItem('cpb_loans', JSON.stringify(loans)); }, [loans]);
    useEffect(() => { localStorage.setItem('cpb_transactions', JSON.stringify(transactions)); }, [transactions]);
    useEffect(() => { localStorage.setItem('cpb_loan_config', JSON.stringify(config)); }, [config]);

    const calcInterest = (loan) => {
        if (!loan.startDate) return 0;
        const start = new Date(loan.startDate), maturity = new Date(loan.maturityDate), today = new Date();
        const end = today < maturity ? today : maturity;
        const days = Math.floor((end - start)/(86400000));
        return Math.max(0, loan.loanAmount * loan.interestRate / 100 * days / 360);
    };

    const calcMetrics = (loan) => {
        const price = prices[loan.collateralType] || 0;
        const collateralValue = loan.collateralAmount * price;
        const interestAccrued = calcInterest(loan);
        const totalOwed = loan.loanAmount + interestAccrued - loan.interestPaid;
        const ratio = collateralValue > 0 ? (collateralValue / loan.loanAmount) * 100 : 0;
        const isAtRisk = ratio <= loan.marginCallThreshold && loan.status === 'Active';
        const mcPrice = loan.collateralAmount > 0 ? (loan.loanAmount * loan.marginCallThreshold)/(loan.collateralAmount*100) : 0;
        const reqCollVal = loan.loanAmount * (loan.originalCollateralRatio/100);
        const topUp = price > 0 ? Math.max(0,(reqCollVal - collateralValue)/price) : 0;
        return {collateralValue, interestAccrued, totalOwed, ratio, isAtRisk, mcPrice, topUp};
    };

    const calcTenor = (s,m) => !s||!m ? 0 : Math.ceil((new Date(m)-new Date(s))/86400000);

    const fetchFromSheets = async () => {
        if (!config.scriptUrl) return;
        setLoading(true);
        try {
            const [lr, tr] = await Promise.all([
                fetch(`${config.scriptUrl}?action=read&sheetName=Loans`).then(r=>r.json()),
                fetch(`${config.scriptUrl}?action=read&sheetName=Transactions`).then(r=>r.json())
            ]);
            if (lr.success && lr.values) {
                setLoans(lr.values.filter(r=>r[0]&&r[1]).map(r=>({
                    id:r[0],counterparty:r[1],loanAmount:+r[2],underlying:r[3],collateralAmount:+r[4],
                    collateralType:r[5],interestRate:+r[6],interestPaid:+r[8],tenor:+r[9],
                    startDate:r[10],maturityDate:r[11],marginCallThreshold:+r[12],
                    originalCollateralRatio:+r[13],status:r[14],createdAt:r[15]
                })));
            }
            if (tr.success && tr.values) {
                setTransactions(tr.values.filter(r=>r[0]&&r[1]).map(r=>({id:r[0],loanId:r[1],type:r[2],amount:+r[3],timestamp:r[4]})));
            }
            setLastSync(new Date());
        } catch(e) { alert('Sync error: '+e.message); }
        setLoading(false);
    };

    useEffect(() => {
        if (config.scriptUrl) { fetchFromSheets(); const t = setInterval(fetchFromSheets,30000); return ()=>clearInterval(t); }
    }, [config.scriptUrl]);

    const addLoan = (d) => {
        const loan = {...d, id:d.loanId||`LOAN-${Date.now()}`, interestPaid:0, tenor:calcTenor(d.startDate,d.maturityDate), status:'Active', createdAt:new Date().toISOString()};
        setLoans(p=>[...p,loan]); setShowAdd(false);
    };

    const updateLoan = (loan) => { setLoans(p=>p.map(l=>l.id===loan.id?loan:l)); setEditingLoan(null); };

    const addTxn = (loanId, type, amount) => {
        const txn = {id:`TXN-${Date.now()}`,loanId,type,amount:+amount,timestamp:new Date().toISOString()};
        setTransactions(p=>[...p,txn]);
        const loan = loans.find(l=>l.id===loanId);
        if (loan) {
            const upd = {...loan};
            if (type==='Collateral Top-up') upd.collateralAmount += +amount;
            else if (type==='Loan Repayment') { upd.loanAmount -= +amount; if(upd.loanAmount<=0) upd.status='Repaid'; }
            else if (type==='Interest Payment') upd.interestPaid += +amount;
            updateLoan(upd);
        }
        setShowTxn(null);
    };

    const exportCSV = () => {
        const rows = loans.map(l => { const m=calcMetrics(l); return [l.id,l.counterparty,l.loanAmount,l.underlying,l.collateralAmount,l.collateralType,l.interestRate,m.interestAccrued.toFixed(2),l.interestPaid,l.tenor,l.startDate,l.maturityDate,l.status,m.ratio.toFixed(2)].join(','); });
        const csv = ['ID,Counterparty,Loan,Currency,Collateral,CollType,Rate%,InterestAccrued,InterestPaid,Tenor,Start,Maturity,Status,Ratio%', ...rows].join('\n');
        const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([csv],{type:'text/csv'})); a.download=`loans-${new Date().toISOString().split('T')[0]}.csv`; a.click();
    };

    const filtered = loans.filter(l => filterStatus==='all' || (filterStatus==='active'&&l.status==='Active') || (filterStatus==='matured'&&l.status==='Matured') || (filterStatus==='repaid'&&l.status==='Repaid') || (filterStatus==='at-risk'&&calcMetrics(l).isAtRisk));

    return (
        <div>
            {/* Toolbar */}
            <div className="flex flex-wrap gap-2 mb-5 justify-between items-center">
                <div className="flex gap-2 flex-wrap">
                    <Select value={filterStatus} onChange={e=>setFilterStatus(e.target.value)} className="w-auto text-xs px-2 py-1.5">
                        <option value="all">All Loans</option>
                        <option value="active">Active</option>
                        <option value="at-risk">At Risk</option>
                        <option value="matured">Matured</option>
                        <option value="repaid">Repaid</option>
                    </Select>
                    {config.scriptUrl && (
                        <button onClick={fetchFromSheets} disabled={loading} className="btn-secondary px-3 py-1.5 rounded-lg text-xs flex items-center gap-1.5">
                            <Icon.Refresh spin={loading}/> Sync Sheets
                        </button>
                    )}
                    <button onClick={exportCSV} className="btn-secondary px-3 py-1.5 rounded-lg text-xs flex items-center gap-1.5"><Icon.Download/> Export</button>
                    <button onClick={()=>setShowSettings(!showSettings)} className="btn-secondary px-3 py-1.5 rounded-lg text-xs flex items-center gap-1.5"><Icon.Settings/> Config</button>
                </div>
                <button onClick={()=>setShowAdd(true)} className="btn-primary px-4 py-2 rounded-lg text-sm font-semibold flex items-center gap-2"><Icon.Plus/> New Loan</button>
            </div>

            {/* Settings Panel */}
            {showSettings && (
                <div className="card p-5 mb-5">
                    <h3 className="font-semibold mb-4 text-sm">Google Sheets Configuration</h3>
                    <div className="space-y-3">
                        <Field label="Apps Script URL" hint="Deploy your Apps Script as a Web App and paste the URL here">
                            <Input value={config.scriptUrl||''} onChange={e=>setConfig({...config,scriptUrl:e.target.value})} placeholder="https://script.google.com/macros/s/.../exec"/>
                        </Field>
                        <Field label="Telegram Bot Token (optional)"><Input value={config.telegramBotToken||''} onChange={e=>setConfig({...config,telegramBotToken:e.target.value})} placeholder="123456789:ABC..."/></Field>
                        <Field label="Telegram Chat ID (optional)"><Input value={config.telegramChatId||''} onChange={e=>setConfig({...config,telegramChatId:e.target.value})} placeholder="-1001234567890"/></Field>
                        <div className="flex gap-2">
                            <button onClick={()=>{localStorage.setItem('cpb_loan_config',JSON.stringify(config));setShowSettings(false);}} className="btn-primary px-4 py-2 rounded-lg text-sm">Save</button>
                            <button onClick={()=>setShowSettings(false)} className="btn-secondary px-4 py-2 rounded-lg text-sm">Cancel</button>
                        </div>
                    </div>
                </div>
            )}

            {/* Loans */}
            {filtered.length === 0 ? (
                <div className="card p-12 text-center">
                    <p className="text-slate-400">No loans found. Create your first loan to get started.</p>
                </div>
            ) : (
                <div className="space-y-3">
                    {filtered.map(loan => {
                        const m = calcMetrics(loan);
                        const txns = transactions.filter(t=>t.loanId===loan.id);
                        return (
                            <div key={loan.id} className={`card p-5 ${m.isAtRisk ? 'border-red-500/40 shadow-lg shadow-red-500/10' : ''}`}>
                                <div className="flex flex-wrap justify-between items-start gap-3 mb-4">
                                    <div>
                                        <div className="flex items-center gap-2 flex-wrap">
                                            <h3 className="font-bold text-lg">{loan.counterparty}</h3>
                                            <span className={`px-2 py-0.5 rounded-full text-xs font-medium ${loan.status==='Active'?'badge-active':loan.status==='Matured'?'badge-matured':'badge-repaid'}`}>{loan.status}</span>
                                            {m.isAtRisk && <span className="px-2 py-0.5 rounded-full text-xs font-medium bg-red-500/20 text-red-400 border border-red-500/30 flex items-center gap-1"><Icon.AlertTriangle/> Margin Call</span>}
                                        </div>
                                        <p className="text-xs text-slate-500 mono mt-0.5">{loan.id} · {fmtDate(loan.startDate)} → {fmtDate(loan.maturityDate)} ({loan.tenor}d)</p>
                                    </div>
                                    <button onClick={()=>setEditingLoan(loan)} className="btn-secondary p-2 rounded-lg"><Icon.Edit/></button>
                                </div>
                                <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-2 mb-4">
                                    {[
                                        ['Loan Amount', `$${fmt(loan.loanAmount)}`, loan.underlying, 'text-white'],
                                        ['Interest Accrued', `$${fmt(m.interestAccrued)}`, `${loan.interestRate}% APR`, 'text-yellow-400'],
                                        ['Total Owed', `$${fmt(m.totalOwed)}`, `Paid: $${fmt(loan.interestPaid)}`, 'text-cyan-400'],
                                        ['Collateral', `${fmtCrypto(loan.collateralAmount,6)} ${loan.collateralType}`, `≈$${fmt(m.collateralValue,0)}`, 'text-white'],
                                        ['Collateral Ratio', `${fmt(m.ratio)}%`, `Target: ${loan.originalCollateralRatio}%`, m.isAtRisk?'text-red-400':'text-green-400'],
                                        ['MC Price', `$${fmt(m.mcPrice,0)}`, `@ ${loan.marginCallThreshold}%`, 'text-orange-400'],
                                    ].map(([lbl,val,sub,cls])=>(
                                        <div key={lbl} className="card-inner p-3">
                                            <p className="text-xs text-slate-400 mb-1">{lbl}</p>
                                            <p className={`font-bold mono text-sm ${cls}`}>{val}</p>
                                            <p className="text-xs text-slate-500">{sub}</p>
                                        </div>
                                    ))}
                                </div>
                                {m.isAtRisk && (
                                    <div className="bg-red-900/20 border border-red-500/30 rounded-lg p-3 mb-3 text-sm">
                                        ⚠️ Required top-up: <span className="font-bold mono text-red-300">{fmtCrypto(m.topUp,8)} {loan.collateralType}</span> to restore to {loan.originalCollateralRatio}%
                                    </div>
                                )}
                                <div className="flex gap-2 flex-wrap">
                                    {[['Collateral Top-up','green'],['Loan Repayment','blue'],['Interest Payment','purple']].map(([t,c])=>(
                                        <button key={t} onClick={()=>setShowTxn({loanId:loan.id,type:t})} className={`px-3 py-1.5 bg-${c}-600/20 hover:bg-${c}-600/40 border border-${c}-500/30 rounded-lg text-xs text-${c}-400 flex items-center gap-1 transition-colors`}><Icon.Plus/>{t}</button>
                                    ))}
                                </div>
                                {txns.length > 0 && (
                                    <div className="mt-3 pt-3 border-t border-slate-800">
                                        <p className="text-xs text-slate-500 mb-2">Recent transactions</p>
                                        <div className="space-y-1">
                                            {txns.slice(-3).reverse().map(t=>(
                                                <div key={t.id} className="flex justify-between text-xs text-slate-400 mono">
                                                    <span>{t.type}: {t.amount}</span><span>{fmtDateTimeSGT(t.timestamp)}</span>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                )}
                            </div>
                        );
                    })}
                </div>
            )}

            {/* Modals */}
            {showAdd && <LoanFormModal title="Create New Loan" onSave={addLoan} onClose={()=>setShowAdd(false)} calcTenor={calcTenor}/>}
            {editingLoan && <LoanFormModal title={`Edit: ${editingLoan.id}`} loan={editingLoan} onSave={updateLoan} onClose={()=>setEditingLoan(null)} calcTenor={calcTenor}/>}
            {showTxn && (
                <Modal title={showTxn.type} onClose={()=>setShowTxn(null)}>
                    <TxnForm onSubmit={(a)=>addTxn(showTxn.loanId,showTxn.type,a)} onCancel={()=>setShowTxn(null)}/>
                </Modal>
            )}
        </div>
    );
};

const LoanFormModal = ({title, loan, onSave, onClose, calcTenor}) => {
    const [form, setForm] = useState(loan || {loanId:'',counterparty:'',loanAmount:'',underlying:'USDT',collateralAmount:'',collateralType:'BTC',interestRate:'',startDate:'',maturityDate:'',marginCallThreshold:120,originalCollateralRatio:130,interestPaid:0,status:'Active'});
    const tenor = calcTenor(form.startDate, form.maturityDate);
    const f = k => e => setForm(p=>({...p,[k]:e.target.value}));
    return (
        <Modal title={title} onClose={onClose} wide>
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                {!loan && <div className="md:col-span-2"><Field label="Loan ID"><Input value={form.loanId} onChange={f('loanId')} placeholder="e.g. LOAN-001"/></Field></div>}
                <div className="md:col-span-2"><Field label="Counterparty"><Input value={form.counterparty} onChange={f('counterparty')}/></Field></div>
                <Field label="Loan Amount"><Input type="number" value={form.loanAmount} onChange={f('loanAmount')} step="0.01"/></Field>
                <Field label="Currency"><Select value={form.underlying} onChange={f('underlying')}><option>USDT</option><option>USDC</option></Select></Field>
                <Field label="Collateral Amount"><Input type="number" value={form.collateralAmount} onChange={f('collateralAmount')} step="0.00000001"/></Field>
                <Field label="Collateral Type"><Select value={form.collateralType} onChange={f('collateralType')}><option>BTC</option><option>ETH</option></Select></Field>
                <Field label="Interest Rate (% APR)"><Input type="number" value={form.interestRate} onChange={f('interestRate')} step="0.01"/></Field>
                {loan && <Field label="Interest Paid"><Input type="number" value={form.interestPaid} onChange={f('interestPaid')} step="0.01"/></Field>}
                <Field label="Start Date"><Input type="date" value={form.startDate} onChange={f('startDate')}/></Field>
                <Field label="Maturity Date"><Input type="date" value={form.maturityDate} onChange={f('maturityDate')}/></Field>
                {tenor > 0 && <div className="md:col-span-2 bg-cyan-900/20 border border-cyan-500/20 rounded-lg p-3 text-xs text-cyan-300">Tenor: {tenor} days</div>}
                <Field label="Margin Call Threshold (%)" hint="Alert when ratio falls below this"><Input type="number" value={form.marginCallThreshold} onChange={f('marginCallThreshold')}/></Field>
                <Field label="Original Collateral Ratio (%)" hint="Target ratio for top-ups"><Input type="number" value={form.originalCollateralRatio} onChange={f('originalCollateralRatio')}/></Field>
                {loan && <Field label="Status"><Select value={form.status} onChange={f('status')}><option>Active</option><option>Matured</option><option>Repaid</option><option>Defaulted</option></Select></Field>}
            </div>
            <div className="flex gap-2 mt-5">
                <button onClick={()=>onSave(form)} className="btn-primary flex-1 px-4 py-2 rounded-lg font-semibold text-sm">{loan ? 'Update' : 'Create'} Loan</button>
                <button onClick={onClose} className="btn-secondary px-4 py-2 rounded-lg text-sm">Cancel</button>
            </div>
        </Modal>
    );
};

const TxnForm = ({onSubmit, onCancel}) => {
    const [amount, setAmount] = useState('');
    return (
        <div>
            <Field label="Amount"><Input type="number" value={amount} onChange={e=>setAmount(e.target.value)} step="0.00000001" placeholder="Enter amount"/></Field>
            <div className="flex gap-2 mt-4">
                <button onClick={()=>onSubmit(amount)} className="btn-primary flex-1 px-4 py-2 rounded-lg text-sm font-semibold">Submit</button>
                <button onClick={onCancel} className="btn-secondary px-4 py-2 rounded-lg text-sm">Cancel</button>
            </div>
        </div>
    );
};

// ═══════════════════════════════════════════════════════════════════════════════
// SSPS MODULE
// ═══════════════════════════════════════════════════════════════════════════════

// Helper: get UTC timestamp for 08:00 UTC on a given date string (YYYY-MM-DD)
const get0800UTCTimestamp = (dateStr) => Math.floor(new Date(`${dateStr}T08:00:00Z`).getTime()/1000);

// Fetch Bybit hourly candle open price at 08:00 UTC for a given symbol and date
const fetchBybitPrice = async (symbol, dateStr) => {
    const ts = get0800UTCTimestamp(dateStr) * 1000;
    const url = `https://api.bybit.com/v5/market/kline?category=spot&symbol=${symbol}&interval=60&start=${ts}&end=${ts+3600000}&limit=1`;
    const res = await fetch(url);
    const data = await res.json();
    if (data.retCode === 0 && data.result?.list?.length > 0) {
        return parseFloat(data.result.list[0][1]); // open price
    }
    throw new Error('No data from Bybit');
};

// Determine trade date from issue datetime (ISO string)
const getTradeDate = (issueDateISO) => {
    const d = new Date(issueDateISO);
    const utcHour = d.getUTCHours() + d.getUTCMinutes()/60;
    if (utcHour >= 8) {
        const next = new Date(d); next.setUTCDate(next.getUTCDate()+1);
        return next.toISOString().split('T')[0];
    }
    return d.toISOString().split('T')[0];
};

// Build the full daily schedule for a contract
const buildSchedule = (contract) => {
    const start = new Date(contract.tradeDate+'T00:00:00Z');
    const end = new Date(contract.maturityDate+'T00:00:00Z');
    const days = [];
    let d = new Date(start);
    while (d <= end) { days.push(d.toISOString().split('T')[0]); d.setUTCDate(d.getUTCDate()+1); }
    return days;
};

// Compute ledger rows from contract + price history
const computeLedger = (contract, priceHistory) => {
    const { notional, baseNotional, trigger, scalingFactor, discountFactor } = contract;
    const schedule = buildSchedule(contract);
    let rows = [], notionalLeft = notional, totalUnderlying = 0, totalNotionalSpent = 0, isFullyInvested = false;

    for (let i = 0; i < schedule.length; i++) {
        const date = schedule[i];
        const priceEntry = priceHistory[date];
        const fixingPrice = priceEntry ? priceEntry[contract.underlying] : null;
        let dodChange = null, triggerHit = false, participationNotional = 0, underlyingBought = 0, notionalUsed = 0;

        if (fixingPrice !== null && fixingPrice !== undefined) {
            let priorPrice = null;
            for (let j = i-1; j >= 0; j--) {
                const pe = priceHistory[schedule[j]];
                if (pe && pe[contract.underlying]) { priorPrice = pe[contract.underlying]; break; }
            }
            if (priorPrice && i > 0) { dodChange = (fixingPrice - priorPrice) / priorPrice; triggerHit = dodChange <= trigger; }
            if (i > 0 && !isFullyInvested) {
                const pScale = triggerHit ? scalingFactor : 1.0;
                notionalUsed = Math.min(baseNotional * pScale, notionalLeft);
                participationNotional = notionalUsed;
                const discountedPrice = fixingPrice * (1 - discountFactor);
                underlyingBought = notionalUsed / discountedPrice;
                notionalLeft = Math.max(0, notionalLeft - notionalUsed);
                totalUnderlying += underlyingBought;
                totalNotionalSpent += notionalUsed;
                if (notionalLeft <= 0.01) isFullyInvested = true;
            }
        }
        rows.push({ date, fixingPrice, dodChange, triggerHit, participationNotional, underlyingBought,
            notionalLeft, totalUnderlying, totalNotionalSpent,
            isFullyInvested: isFullyInvested && i > 0 && notionalUsed > 0 });
    }
    return rows;
};

// ─── SHEETS API HELPERS ───────────────────────────────────────────────────────
const sheetsCall = async (scriptUrl, payload) => {
    const qs = Object.entries(payload).map(([k,v]) => `${k}=${encodeURIComponent(typeof v === 'object' ? JSON.stringify(v) : v)}`).join('&');
    const res = await fetch(`${scriptUrl}?${qs}`);
    const data = await res.json();
    if (!data.success) throw new Error(data.error || 'Sheets error');
    return data;
};

const SSPSModule = ({prices, fetchingPrices}) => {
    const [contracts, setContracts] = useState(() => { try { return JSON.parse(localStorage.getItem('cpb_ssps_contracts')||'[]'); } catch { return []; } });
    const [priceHistory, setPriceHistory] = useState(() => { try { return JSON.parse(localStorage.getItem('cpb_ssps_prices')||'{}'); } catch { return {}; } });
    const [config, setConfig] = useState(() => { try { return JSON.parse(localStorage.getItem('cpb_ssps_config')||'{}'); } catch { return {}; } });
    const [showAdd, setShowAdd] = useState(false);
    const [showSettings, setShowSettings] = useState(false);
    const [drillContract, setDrillContract] = useState(null);
    const [fetchingDate, setFetchingDate] = useState(null);
    const [lastAutoFetch, setLastAutoFetch] = useState(null);
    const [syncStatus, setSyncStatus] = useState(null); // null | 'syncing' | 'ok' | 'error'
    const [lastSync, setLastSync] = useState(null);
    const [loading, setLoading] = useState(false);

    useEffect(() => { localStorage.setItem('cpb_ssps_contracts', JSON.stringify(contracts)); }, [contracts]);
    useEffect(() => { localStorage.setItem('cpb_ssps_prices', JSON.stringify(priceHistory)); }, [priceHistory]);
    useEffect(() => { localStorage.setItem('cpb_ssps_config', JSON.stringify(config)); }, [config]);

    // ── Sheets: push contract metadata row ──────────────────────────────────
    const pushContractToSheets = async (contract) => {
        if (!config.scriptUrl) return;
        try {
            setSyncStatus('syncing');
            await sheetsCall(config.scriptUrl, {
                action: 'upsertContract',
                values: [
                    contract.id, contract.clientName, contract.clientEmail,
                    contract.issueDatetime, contract.tradeDate, contract.participationStart,
                    contract.maturityDate, contract.tenor, contract.fixingDays,
                    contract.underlying, contract.notional, contract.baseNotional,
                    (contract.trigger*100).toFixed(2), contract.scalingFactor,
                    (contract.discountFactor*100).toFixed(2), contract.status, contract.createdAt
                ]
            });
            setSyncStatus('ok'); setLastSync(new Date());
        } catch(e) { console.error('Sheets push error', e); setSyncStatus('error'); }
    };

    // ── Sheets: push a daily price + ledger row ──────────────────────────────
    const pushPriceRowToSheets = async (dateStr, entry, contract) => {
        if (!config.scriptUrl || !contract) return;
        try {
            setSyncStatus('syncing');
            // Push to PriceHistory sheet
            await sheetsCall(config.scriptUrl, {
                action: 'upsertPrice',
                values: [dateStr, entry.BTC||'', entry.ETH||'', entry.fetchedAt||'', entry.manualOverride?'YES':'NO']
            });
            // Push/update each active contract's per-contract sheet tab
            const ledger = computeLedger(contract, {...priceHistory, [dateStr]: entry});
            const row = ledger.find(r => r.date === dateStr);
            if (row) {
                const discountedPrice = row.fixingPrice ? row.fixingPrice * (1 - contract.discountFactor) : '';
                await sheetsCall(config.scriptUrl, {
                    action: 'upsertLedgerRow',
                    contractId: contract.id,
                    values: [
                        row.date,
                        row.fixingPrice || '',
                        discountedPrice,
                        row.dodChange !== null ? (row.dodChange*100).toFixed(4) : '',
                        row.triggerHit ? 'YES' : (row.dodChange !== null ? 'NO' : ''),
                        row.triggerHit ? contract.scalingFactor : (row.dodChange !== null ? 1 : ''),
                        row.participationNotional || '',
                        row.underlyingBought || '',
                        row.notionalLeft,
                        row.totalUnderlying,
                        row.totalNotionalSpent,
                        row.isFullyInvested ? 'YES' : ''
                    ]
                });
            }
            setSyncStatus('ok'); setLastSync(new Date());
        } catch(e) { console.error('Sheets push error', e); setSyncStatus('error'); }
    };

    // ── Sheets: full read (contracts + prices) ───────────────────────────────
    const fetchFromSheets = async () => {
        if (!config.scriptUrl) return;
        setLoading(true);
        try {
            setSyncStatus('syncing');
            const [cr, pr] = await Promise.all([
                sheetsCall(config.scriptUrl, {action:'readContracts'}),
                sheetsCall(config.scriptUrl, {action:'readPrices'})
            ]);
            if (cr.values && cr.values.length > 0) {
                const loaded = cr.values.map(r => ({
                    id:r[0], clientName:r[1], clientEmail:r[2], issueDatetime:r[3],
                    tradeDate:r[4], participationStart:r[5], maturityDate:r[6],
                    tenor:+r[7], fixingDays:+r[8], underlying:r[9],
                    notional:+r[10], baseNotional:+r[11],
                    trigger:parseFloat(r[12])/100, scalingFactor:+r[13],
                    discountFactor:parseFloat(r[14])/100,
                    status:r[15], createdAt:r[16]
                }));
                setContracts(loaded);
            }
            if (pr.values && pr.values.length > 0) {
                const hist = {};
                pr.values.forEach(r => {
                    if (r[0]) hist[r[0]] = { BTC: r[1]?+r[1]:null, ETH: r[2]?+r[2]:null, fetchedAt:r[3], manualOverride: r[4]==='YES' };
                });
                setPriceHistory(hist);
            }
            setSyncStatus('ok'); setLastSync(new Date());
        } catch(e) { console.error('Sheets fetch error', e); setSyncStatus('error'); }
        setLoading(false);
    };

    // Auto-sync from Sheets every 30s if configured
    useEffect(() => {
        if (config.scriptUrl) {
            fetchFromSheets();
            const t = setInterval(fetchFromSheets, 30000);
            return () => clearInterval(t);
        }
    }, [config.scriptUrl]);

    // Auto-fetch prices at 16:00 SGT = 08:00 UTC
    useEffect(() => {
        const checkAndFetch = () => {
            const now = new Date();
            const sgtHour = (now.getUTCHours() + 8) % 24;
            const sgtMin = now.getUTCMinutes();
            const todayStr = now.toISOString().split('T')[0];
            if (sgtHour === 16 && sgtMin < 5 && lastAutoFetch !== todayStr) {
                fetchTodayPrices(todayStr);
                setLastAutoFetch(todayStr);
            }
        };
        const t = setInterval(checkAndFetch, 60000);
        checkAndFetch();
        return () => clearInterval(t);
    }, [lastAutoFetch, contracts]);

    const fetchTodayPrices = async (dateStr) => {
        setFetchingDate(dateStr);
        let entry = { fetchedAt: new Date().toISOString() };
        try {
            const [btc, eth] = await Promise.allSettled([
                fetchBybitPrice('BTCUSDT', dateStr),
                fetchBybitPrice('ETHUSDT', dateStr)
            ]);
            entry.BTC = btc.status==='fulfilled' ? btc.value : null;
            entry.ETH = eth.status==='fulfilled' ? eth.value : null;
            if (!entry.BTC && !entry.ETH) throw new Error('Both fetches failed');
        } catch(e) {
            console.error('Bybit fetch failed:', e);
            entry.fetchError = true;
        }
        const newHistory = {...priceHistory, [dateStr]: entry};
        setPriceHistory(newHistory);
        // Auto-push each active contract's row to Sheets
        for (const c of contracts) {
            if (new Date(c.tradeDate) <= new Date(dateStr) && new Date(dateStr) <= new Date(c.maturityDate)) {
                await pushPriceRowToSheets(dateStr, entry, c);
            }
        }
        setFetchingDate(null);
    };

    const manualPriceOverride = async (dateStr, btcVal, ethVal) => {
        const entry = {
            ...(priceHistory[dateStr]||{}),
            BTC: btcVal ? parseFloat(btcVal) : (priceHistory[dateStr]?.BTC || null),
            ETH: ethVal ? parseFloat(ethVal) : (priceHistory[dateStr]?.ETH || null),
            manualOverride: true,
            fetchedAt: new Date().toISOString()
        };
        const newHistory = {...priceHistory, [dateStr]: entry};
        setPriceHistory(newHistory);
        // Auto-push each active contract's row
        for (const c of contracts) {
            if (new Date(c.tradeDate) <= new Date(dateStr) && new Date(dateStr) <= new Date(c.maturityDate)) {
                await pushPriceRowToSheets(dateStr, entry, c);
            }
        }
    };

    const addContract = async (c) => {
        setContracts(p=>[...p,c]);
        setShowAdd(false);
        await pushContractToSheets(c);
    };

    const deleteContract = (id) => {
        if (confirm('Delete this contract? This will only remove it locally — delete the sheet tab manually if needed.'))
            setContracts(p=>p.filter(c=>c.id!==id));
    };

    const exportData = () => {
        const blob = new Blob([JSON.stringify({contracts, priceHistory}, null, 2)], {type:'application/json'});
        const a = document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=`ssps-data-${new Date().toISOString().split('T')[0]}.json`; a.click();
    };

    const importData = (e) => {
        const file = e.target.files[0]; if (!file) return;
        const reader = new FileReader();
        reader.onload = (ev) => {
            try { const d = JSON.parse(ev.target.result); if (d.contracts) setContracts(d.contracts); if (d.priceHistory) setPriceHistory(d.priceHistory); } catch { alert('Invalid file'); }
        };
        reader.readAsText(file);
    };

    // If drilling into a contract
    if (drillContract) {
        // Keep drillContract in sync with latest state
        const liveContract = contracts.find(c=>c.id===drillContract.id) || drillContract;
        return <SSPSLedger
            contract={liveContract}
            priceHistory={priceHistory}
            prices={prices}
            onBack={()=>setDrillContract(null)}
            onFetchPrice={fetchTodayPrices}
            onManualPrice={manualPriceOverride}
            fetchingDate={fetchingDate}
            scriptUrl={config.scriptUrl}
        />;
    }

    const syncColor = syncStatus==='ok' ? 'text-green-400' : syncStatus==='error' ? 'text-red-400' : syncStatus==='syncing' ? 'text-yellow-400' : 'text-slate-500';
    const syncLabel = syncStatus==='ok' ? `Synced ${lastSync ? lastSync.toLocaleTimeString() : ''}` : syncStatus==='error' ? 'Sync error' : syncStatus==='syncing' ? 'Syncing…' : 'Not configured';

    return (
        <div>
            {/* Toolbar */}
            <div className="flex flex-wrap gap-2 mb-5 justify-between items-center">
                <div className="flex gap-2 flex-wrap items-center">
                    <button onClick={exportData} className="btn-secondary px-3 py-1.5 rounded-lg text-xs flex items-center gap-1.5"><Icon.Download/> Export JSON</button>
                    <label className="btn-secondary px-3 py-1.5 rounded-lg text-xs flex items-center gap-1.5 cursor-pointer"><Icon.Upload/> Import JSON<input type="file" accept=".json" onChange={importData} className="hidden"/></label>
                    <button onClick={()=>fetchTodayPrices(new Date().toISOString().split('T')[0])} disabled={!!fetchingDate} className="btn-secondary px-3 py-1.5 rounded-lg text-xs flex items-center gap-1.5">
                        <Icon.Refresh spin={!!fetchingDate}/> Fetch Today's Prices
                    </button>
                    {config.scriptUrl && (
                        <button onClick={fetchFromSheets} disabled={loading} className="btn-secondary px-3 py-1.5 rounded-lg text-xs flex items-center gap-1.5">
                            <Icon.Refresh spin={loading}/> Sync Sheets
                        </button>
                    )}
                    <button onClick={()=>setShowSettings(!showSettings)} className="btn-secondary px-3 py-1.5 rounded-lg text-xs flex items-center gap-1.5"><Icon.Settings/> Sheets Config</button>
                    <span className={`text-xs ${syncColor} flex items-center gap-1`}>
                        {syncStatus==='ok' && <Icon.Check/>}{syncLabel}
                    </span>
                </div>
                <button onClick={()=>setShowAdd(true)} className="btn-primary px-4 py-2 rounded-lg text-sm font-semibold flex items-center gap-2"><Icon.Plus/> New Contract</button>
            </div>

            {/* Settings Panel */}
            {showSettings && (
                <div className="card p-5 mb-5">
                    <h3 className="font-semibold mb-1 text-sm">Google Sheets Configuration — SSPS</h3>
                    <p className="text-xs text-slate-500 mb-4">Separate from the Loans spreadsheet. Deploy the SSPS Apps Script and paste its URL below.</p>
                    <div className="space-y-3">
                        <Field label="SSPS Apps Script URL" hint="Deploy as Web App (Anyone, even anonymous). Manages Contracts, PriceHistory, and per-contract ledger tabs.">
                            <Input value={config.scriptUrl||''} onChange={e=>setConfig(p=>({...p,scriptUrl:e.target.value}))} placeholder="https://script.google.com/macros/s/.../exec"/>
                        </Field>
                        <div className="bg-slate-900 border border-slate-700 rounded-lg p-3 text-xs text-slate-400 space-y-1.5">
                            <p className="text-slate-300 font-medium">Setup checklist:</p>
                            <p>① Create a new Google Spreadsheet (keep it empty — the script creates all tabs)</p>
                            <p>② In the spreadsheet, go to Extensions → Apps Script</p>
                            <p>③ Paste the SSPS Apps Script code (provided separately as <span className="text-cyan-400 mono">ssps-apps-script.gs</span>)</p>
                            <p>④ Click Deploy → New Deployment → Web App → Execute as Me → Anyone can access</p>
                            <p>⑤ Copy the deployment URL and paste above</p>
                            <p>⑥ Click "Sync Sheets" to verify the connection</p>
                        </div>
                        <div className="flex gap-2">
                            <button onClick={()=>{setShowSettings(false); if(config.scriptUrl) fetchFromSheets();}} className="btn-primary px-4 py-2 rounded-lg text-sm">Save & Connect</button>
                            <button onClick={()=>setShowSettings(false)} className="btn-secondary px-4 py-2 rounded-lg text-sm">Cancel</button>
                        </div>
                    </div>
                </div>
            )}

            {/* Price History Status */}
            {(() => {
                const today = new Date().toISOString().split('T')[0];
                const todayEntry = priceHistory[today];
                return todayEntry ? (
                    <div className="bg-green-900/20 border border-green-500/30 rounded-lg p-3 mb-4 text-xs text-green-400 flex items-center gap-2 flex-wrap">
                        <Icon.Check/>
                        <span>Today's prices loaded</span>
                        {todayEntry.BTC && <span className="mono">BTC: ${fmt(todayEntry.BTC,0)}</span>}
                        {todayEntry.ETH && <span className="mono">ETH: ${fmt(todayEntry.ETH,0)}</span>}
                        {todayEntry.manualOverride && <span className="text-yellow-400">(manual override)</span>}
                        {todayEntry.fetchError && <span className="text-yellow-400">(fetch failed — manual entry may be needed)</span>}
                    </div>
                ) : (
                    <div className="bg-yellow-900/20 border border-yellow-500/30 rounded-lg p-3 mb-4 text-xs text-yellow-400 flex items-center gap-2">
                        <Icon.AlertTriangle/> Today's prices not yet fetched. Auto-fetch runs at 16:00 SGT, or click "Fetch Today's Prices".
                    </div>
                );
            })()}

            {/* Contracts Dashboard */}
            {contracts.length === 0 ? (
                <div className="card p-12 text-center">
                    <p className="text-slate-400">No SSPS contracts yet. Create your first contract.</p>
                </div>
            ) : (
                <div className="space-y-3">
                    {contracts.map(c => <SSPSContractCard key={c.id} contract={c} priceHistory={priceHistory} prices={prices} onDrill={()=>setDrillContract(c)} onDelete={()=>deleteContract(c.id)}/>)}
                </div>
            )}

            {showAdd && <SSPSFormModal onSave={addContract} onClose={()=>setShowAdd(false)}/>}
        </div>
    );
};

// SSPS Contract Summary Card
const SSPSContractCard = ({contract, priceHistory, prices, onDrill, onDelete}) => {
    const ledger = useMemo(()=>computeLedger(contract, priceHistory), [contract, priceHistory]);
    const lastRow = ledger.filter(r=>r.fixingPrice).slice(-1)[0];
    const notionalLeft = lastRow ? lastRow.notionalLeft : contract.notional;
    const totalUnderlying = lastRow ? lastRow.totalUnderlying : 0;
    const totalSpent = lastRow ? lastRow.totalNotionalSpent : 0;
    const livePrice = prices[contract.underlying] || 0;
    const mtmValue = totalUnderlying * livePrice;
    const pnl = mtmValue - totalSpent;
    const avgCost = totalUnderlying > 0 ? totalSpent / totalUnderlying : 0;
    const isFullyInvested = notionalLeft <= 0.01;
    const today = new Date().toISOString().split('T')[0];
    const isMatured = today > contract.maturityDate;
    const fixingDays = ledger.length;
    const daysWithPrice = ledger.filter(r=>r.fixingPrice).length;
    const pctComplete = fixingDays > 0 ? Math.round(daysWithPrice/fixingDays*100) : 0;
    const daysLeft = Math.max(0, Math.ceil((new Date(contract.maturityDate)-new Date())/(86400000)));

    let status = 'Active';
    if (isMatured) status = 'Matured';
    else if (isFullyInvested) status = 'Fully Invested';

    return (
        <div className={`card p-5 cursor-pointer hover:border-slate-600 transition-all ${isFullyInvested && !isMatured ? 'fully-invested-glow' : ''}`} onClick={onDrill}>
            <div className="flex flex-wrap justify-between items-start gap-3 mb-4">
                <div>
                    <div className="flex items-center gap-2 flex-wrap">
                        <h3 className="font-bold text-lg">{contract.clientName}</h3>
                        <span className={`px-2 py-0.5 rounded-full text-xs font-medium ${status==='Active'?'badge-active':status==='Matured'?'badge-matured':'badge-invested'}`}>
                            {status==='Fully Invested' && <><Icon.Lock/>{' '}</>}{status}
                        </span>
                        <span className={`px-2 py-0.5 rounded-full text-xs font-medium ${contract.underlying==='BTC'?'bg-orange-500/15 text-orange-400 border border-orange-500/25':'bg-purple-500/15 text-purple-400 border border-purple-500/25'}`}>{contract.underlying}/USDT</span>
                    </div>
                    <p className="text-xs text-slate-500 mono mt-0.5">{contract.id} · {fmtDate(contract.tradeDate)} → {fmtDate(contract.maturityDate)} · {contract.tenor}d</p>
                </div>
                <div className="flex gap-2" onClick={e=>e.stopPropagation()}>
                    <button onClick={onDrill} className="btn-secondary px-3 py-1.5 rounded-lg text-xs flex items-center gap-1">Ledger <Icon.ChevronRight/></button>
                    <button onClick={onDelete} className="p-2 rounded-lg bg-red-900/20 border border-red-500/20 text-red-400 hover:bg-red-900/40 transition-colors"><Icon.Trash/></button>
                </div>
            </div>

            <div className="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-8 gap-2 mb-3">
                {[
                    ['Notional', `$${fmt(contract.notional,0)}`, 'USDT', 'text-white'],
                    ['Invested', `$${fmt(totalSpent,0)}`, `${fmt(100-notionalLeft/contract.notional*100,1)}% deployed`, 'text-cyan-400'],
                    ['Remaining', `$${fmt(notionalLeft,0)}`, isFullyInvested?'🔒 Fully invested':'available', notionalLeft<500?'text-yellow-400':'text-white'],
                    [`${contract.underlying} Bought`, fmtCrypto(totalUnderlying,6), `avg $${fmt(avgCost,0)}`, 'text-white'],
                    ['MTM Value', `$${fmt(mtmValue,0)}`, `@ $${fmt(livePrice,0)}`, 'text-white'],
                    ['P&L', `${pnl>=0?'+':''}$${fmt(Math.abs(pnl),0)}`, `${pnl>=0?'+':''}${totalSpent>0?fmt(pnl/totalSpent*100,2):'0.00'}%`, pnl>=0?'text-green-400':'text-red-400'],
                    ['Progress', `${pctComplete}%`, `${daysWithPrice}/${fixingDays} days`, 'text-slate-300'],
                    ['Days Left', isMatured?'Matured':`${daysLeft}d`, isMatured?fmtDate(contract.maturityDate):'to maturity', daysLeft<=7&&!isMatured?'text-yellow-400':'text-slate-300'],
                ].map(([lbl,val,sub,cls])=>(
                    <div key={lbl} className="card-inner p-2.5">
                        <p className="text-xs text-slate-400 mb-1 truncate">{lbl}</p>
                        <p className={`font-bold mono text-xs ${cls}`}>{val}</p>
                        <p className="text-xs text-slate-500 truncate">{sub}</p>
                    </div>
                ))}
            </div>

            {/* Progress bar */}
            <div className="h-1.5 bg-slate-800 rounded-full overflow-hidden">
                <div className="h-full bg-gradient-to-r from-cyan-500 to-blue-500 rounded-full transition-all" style={{width:`${pctComplete}%`}}/>
            </div>
        </div>
    );
};

// SSPS Daily Ledger Drill-down
const SSPSLedger = ({contract, priceHistory, prices, onBack, onFetchPrice, onManualPrice, fetchingDate, scriptUrl}) => {
    const ledger = useMemo(()=>computeLedger(contract, priceHistory), [contract, priceHistory]);
    const [manualInputs, setManualInputs] = useState({});
    const [showManualDate, setShowManualDate] = useState(null);
    const [saving, setSaving] = useState(false);

    const lastRow = ledger.filter(r=>r.fixingPrice).slice(-1)[0];
    const totalUnderlying = lastRow ? lastRow.totalUnderlying : 0;
    const totalSpent = lastRow ? lastRow.totalNotionalSpent : 0;
    const notionalLeft = lastRow ? lastRow.notionalLeft : contract.notional;
    const livePrice = prices[contract.underlying] || 0;
    const mtmValue = totalUnderlying * livePrice;
    const pnl = mtmValue - totalSpent;
    const avgCost = totalUnderlying > 0 ? totalSpent / totalUnderlying : 0;
    const isFullyInvested = notionalLeft <= 0.01;

    const handleManualSave = async (date) => {
        const entry = manualInputs[date] || {};
        setSaving(true);
        await onManualPrice(date, entry.BTC||'', entry.ETH||'');
        setSaving(false);
        setShowManualDate(null);
        setManualInputs(p=>({...p,[date]:{}}));
    };

    const today = new Date().toISOString().split('T')[0];

    return (
        <div>
            {/* Back */}
            <div className="flex items-center gap-2 mb-5">
                <button onClick={onBack} className="drill-back flex items-center gap-1 text-sm font-medium"><Icon.ChevronLeft/> All Contracts</button>
                <span className="text-slate-600">/</span>
                <span className="text-slate-300 text-sm">{contract.clientName}</span>
                <span className="text-slate-600 text-sm">({contract.id})</span>
            </div>

            {/* Summary cards */}
            <div className="grid grid-cols-2 md:grid-cols-4 gap-3 mb-5">
                {[
                    ['Total Invested', `$${fmt(totalSpent)}`, `of $${fmt(contract.notional,0)} notional`, 'text-cyan-400'],
                    [`${contract.underlying} Accumulated`, fmtCrypto(totalUnderlying,8), `avg cost $${fmt(avgCost,2)}`, 'text-white'],
                    ['MTM Value', `$${fmt(mtmValue)}`, `live @ $${fmt(livePrice,0)}`, 'text-white'],
                    ['Unrealised P&L', `${pnl>=0?'+':''}$${fmt(Math.abs(pnl))}`, `${totalSpent>0?fmt(pnl/totalSpent*100,2):'0.00'}% return`, pnl>=0?'profit':'loss'],
                ].map(([lbl,val,sub,cls])=>(
                    <div key={lbl} className="card p-4">
                        <p className="text-xs text-slate-400 mb-1">{lbl}</p>
                        <p className={`text-xl font-bold mono ${cls}`}>{val}</p>
                        <p className="text-xs text-slate-500">{sub}</p>
                    </div>
                ))}
            </div>

            {isFullyInvested && (
                <div className="bg-amber-900/20 border border-amber-500/30 rounded-lg p-4 mb-4">
                    <p className="text-amber-300 font-semibold text-sm flex items-center gap-2"><Icon.Lock/> Notional Fully Invested</p>
                    <p className="text-xs text-slate-400 mt-1">All {contract.underlying} will be held until maturity ({fmtDate(contract.maturityDate)}).</p>
                    <p className="text-xs text-slate-300 mt-1">Estimated final payout: <span className="mono font-bold text-amber-300">${fmt(mtmValue)}</span> (at current price ${fmt(livePrice,0)})</p>
                </div>
            )}

            {/* Contract params */}
            <div className="card p-4 mb-4">
                <div className="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-3 text-xs">
                    {[
                        ['Contract ID', contract.id],
                        ['Underlying', `${contract.underlying}/USDT`],
                        ['Trade Date', fmtDate(contract.tradeDate)],
                        ['Participation Start', fmtDate(contract.participationStart)],
                        ['Maturity', fmtDate(contract.maturityDate)],
                        ['Tenor', `${contract.tenor} days`],
                        ['Notional', `$${fmt(contract.notional,0)}`],
                        ['Base Daily Notional', `$${fmt(contract.baseNotional,2)}`],
                        ['Perf. Trigger', `${(contract.trigger*100).toFixed(1)}%`],
                        ['Scaling Factor', `${contract.scalingFactor}x`],
                        ['Discount Factor', `${(contract.discountFactor*100).toFixed(2)}%`],
                        ['Fixing Days', `${ledger.length}`],
                    ].map(([k,v])=>(
                        <div key={k} className="card-inner p-2.5">
                            <p className="text-slate-400 mb-0.5">{k}</p>
                            <p className="font-medium mono text-slate-200">{v}</p>
                        </div>
                    ))}
                </div>
            </div>

            {/* Price fetch controls */}
            <div className="flex gap-2 mb-4 flex-wrap">
                <button onClick={()=>onFetchPrice(today)} disabled={!!fetchingDate} className="btn-secondary px-3 py-1.5 rounded-lg text-xs flex items-center gap-1.5">
                    <Icon.Refresh spin={!!fetchingDate}/> Fetch Today ({today})
                </button>
                <button onClick={()=>setShowManualDate(today)} className="btn-secondary px-3 py-1.5 rounded-lg text-xs flex items-center gap-1.5">
                    <Icon.Edit/> Manual Price Override
                </button>
            </div>

            {showManualDate && (
                <div className="card p-4 mb-4">
                    <p className="text-sm font-medium mb-3">Manual Price Override for {showManualDate}</p>
                    <div className="grid grid-cols-2 gap-3 mb-3">
                        <Field label="BTC/USDT Open Price (08:00 UTC)">
                            <Input type="number" placeholder={`Current: ${priceHistory[showManualDate]?.BTC || 'N/A'}`} onChange={e=>setManualInputs(p=>({...p,[showManualDate]:{...p[showManualDate],BTC:e.target.value}}))} step="0.01"/>
                        </Field>
                        <Field label="ETH/USDT Open Price (08:00 UTC)">
                            <Input type="number" placeholder={`Current: ${priceHistory[showManualDate]?.ETH || 'N/A'}`} onChange={e=>setManualInputs(p=>({...p,[showManualDate]:{...p[showManualDate],ETH:e.target.value}}))} step="0.01"/>
                        </Field>
                    </div>
                    <div className="flex gap-2">
                        <button onClick={()=>handleManualSave(showManualDate)} disabled={saving} className="btn-primary px-3 py-1.5 rounded-lg text-xs flex items-center gap-1.5">
                            {saving ? <><Icon.Refresh spin={true}/> Saving…</> : <><Icon.Check/> Save Override</>}
                        </button>
                        <button onClick={()=>{setShowManualDate(null);}} className="btn-secondary px-3 py-1.5 rounded-lg text-xs">Cancel</button>
                        <div className="ml-2">
                            <Input type="date" value={showManualDate} onChange={e=>setShowManualDate(e.target.value)} className="text-xs py-1.5"/>
                        </div>
                    </div>
                </div>
            )}

            {/* Daily Ledger Table */}
            <div className="card overflow-hidden">
                <div className="overflow-x-auto scrollbar-hide">
                    <table className="w-full text-xs">
                        <thead>
                            <tr className="border-b border-slate-800">
                                {['#','Date','Open Price (08:00 UTC)','Disc. Price','DoD Change','Trigger','Participation Notional','Disc. Factor','Underlying Bought','Notional Left','Cumul. Underlying','Notes'].map(h=>(
                                    <th key={h} className="text-left px-3 py-2.5 text-slate-400 font-medium whitespace-nowrap">{h}</th>
                                ))}
                            </tr>
                        </thead>
                        <tbody>
                            {ledger.map((row, i) => {
                                const ph = priceHistory[row.date];
                                const rawPrice = ph ? ph[contract.underlying] : null;
                                const discountedPrice = rawPrice ? rawPrice * (1 - contract.discountFactor) : null;
                                const isToday = row.date === today;
                                const isFuture = row.date > today;
                                return (
                                    <tr key={row.date} className={`border-b border-slate-800/50 ${row.triggerHit ? 'trigger-row' : ''} ${isToday ? 'bg-cyan-900/10' : ''} ${isFuture ? 'opacity-40' : 'table-row-hover'}`}>
                                        <td className="px-3 py-2 mono text-slate-500">{i}</td>
                                        <td className="px-3 py-2 mono text-slate-300 whitespace-nowrap">
                                            {row.date}
                                            {isToday && <span className="ml-1 px-1 py-0.5 bg-cyan-500/20 text-cyan-400 rounded text-xs">today</span>}
                                        </td>
                                        <td className="px-3 py-2 mono">
                                            {rawPrice ? (
                                                <span className="text-white">${fmt(rawPrice, 2)}</span>
                                            ) : isFuture ? (
                                                <span className="text-slate-600">—</span>
                                            ) : (
                                                <button onClick={()=>setShowManualDate(row.date)} className="text-yellow-500 hover:text-yellow-400 flex items-center gap-1"><Icon.Edit/> Enter</button>
                                            )}
                                        </td>
                                        <td className="px-3 py-2 mono text-slate-400">
                                            {discountedPrice ? `$${fmt(discountedPrice,2)}` : '—'}
                                        </td>
                                        <td className={`px-3 py-2 mono ${row.dodChange === null ? 'text-slate-600' : row.dodChange <= contract.trigger ? 'text-red-400' : 'text-slate-300'}`}>
                                            {row.dodChange !== null ? `${(row.dodChange*100).toFixed(2)}%` : i===0 ? 'Initial' : '—'}
                                        </td>
                                        <td className="px-3 py-2">
                                            {row.triggerHit ? <span className="px-1.5 py-0.5 bg-red-500/20 text-red-400 rounded text-xs">{contract.scalingFactor}x</span> : row.dodChange !== null ? <span className="text-slate-500">1x</span> : '—'}
                                        </td>
                                        <td className="px-3 py-2 mono text-slate-300">
                                            {row.participationNotional > 0 ? `$${fmt(row.participationNotional,2)}` : i===0 ? <span className="text-slate-500">Initial fixing</span> : '—'}
                                        </td>
                                        <td className="px-3 py-2 mono text-slate-500">
                                            {contract.discountFactor > 0 ? `${(contract.discountFactor*100).toFixed(2)}%` : '—'}
                                        </td>
                                        <td className="px-3 py-2 mono text-slate-300">
                                            {row.underlyingBought > 0 ? fmtCrypto(row.underlyingBought,8) : '—'}
                                        </td>
                                        <td className="px-3 py-2 mono">
                                            {rawPrice ? (
                                                <span className={row.notionalLeft <= 0.01 ? 'text-amber-400' : 'text-slate-300'}>${fmt(row.notionalLeft,2)}</span>
                                            ) : '—'}
                                        </td>
                                        <td className="px-3 py-2 mono text-slate-300">
                                            {row.totalUnderlying > 0 ? fmtCrypto(row.totalUnderlying,8) : '—'}
                                        </td>
                                        <td className="px-3 py-2 text-slate-500 text-xs">
                                            {row.isFullyInvested ? <span className="text-amber-400 flex items-center gap-1"><Icon.Lock/> Fully invested</span> : i===0 ? 'Initial fixing day' : ''}
                                        </td>
                                    </tr>
                                );
                            })}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    );
};

// SSPS New Contract Form
const SSPSFormModal = ({onSave, onClose}) => {
    const now = new Date();
    const nowISO = now.toISOString().slice(0,16);
    const [form, setForm] = useState({
        contractId:'', clientName:'', clientEmail:'',
        issueDatetime: nowISO,
        underlying:'BTC', notional:100000,
        trigger:-0.03, scalingFactor:1.5, discountFactor:0,
        maturityMonths:3,
    });
    const [computed, setComputed] = useState({});

    useEffect(() => {
        if (!form.issueDatetime) return;
        const issueISO = form.issueDatetime + ':00Z';
        const tradeDate = getTradeDate(issueISO);
        const tradeD = new Date(tradeDate+'T00:00:00Z');
        const participationStart = new Date(tradeD); participationStart.setUTCDate(participationStart.getUTCDate()+1);
        const maturity = new Date(tradeD); maturity.setUTCMonth(maturity.getUTCMonth()+form.maturityMonths);
        const maturityDate = maturity.toISOString().split('T')[0];
        const fixingDays = Math.ceil((maturity - tradeD)/86400000) + 1;
        const tenor = fixingDays - 1;
        const baseNotional = fixingDays > 2 ? form.notional / (fixingDays - 2) : 0;
        setComputed({tradeDate, participationStart:participationStart.toISOString().split('T')[0], maturityDate, fixingDays, tenor, baseNotional});
    }, [form.issueDatetime, form.notional, form.maturityMonths]);

    const f = k => e => setForm(p=>({...p,[k]:e.target.type==='number'?parseFloat(e.target.value):e.target.value}));

    const handleSave = () => {
        if (!computed.tradeDate) return alert('Please check issue date/time');
        const contract = {
            id: form.contractId || `SSPS-${Date.now()}`,
            clientName: form.clientName, clientEmail: form.clientEmail,
            issueDatetime: form.issueDatetime+':00Z',
            tradeDate: computed.tradeDate,
            participationStart: computed.participationStart,
            maturityDate: computed.maturityDate,
            tenor: computed.tenor, fixingDays: computed.fixingDays,
            underlying: form.underlying, notional: form.notional,
            baseNotional: computed.baseNotional,
            trigger: form.trigger, scalingFactor: form.scalingFactor,
            discountFactor: form.discountFactor,
            status: 'Active', createdAt: new Date().toISOString()
        };
        onSave(contract);
    };

    return (
        <Modal title="New SSPS Contract" onClose={onClose} wide>
            <div className="space-y-5">
                {/* Client Details */}
                <div>
                    <p className="text-xs font-semibold text-slate-400 uppercase tracking-wider mb-3">Client Details</p>
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                        <Field label="Contract ID" hint="Auto-generated if left blank"><Input value={form.contractId} onChange={f('contractId')} placeholder="e.g. 0WWHJ1TSA-SSPS-2026-1"/></Field>
                        <Field label="Client Name"><Input value={form.clientName} onChange={f('clientName')}/></Field>
                        <div className="md:col-span-2"><Field label="Client Email"><Input type="email" value={form.clientEmail} onChange={f('clientEmail')}/></Field></div>
                    </div>
                </div>

                {/* Trade Terms */}
                <div>
                    <p className="text-xs font-semibold text-slate-400 uppercase tracking-wider mb-3">Trade Terms</p>
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                        <Field label="Issue Date & Time (SGT)" hint="If after 08:00 UTC, trade date will be +1 day">
                            <Input type="datetime-local" value={form.issueDatetime} onChange={f('issueDatetime')}/>
                        </Field>
                        <Field label="Underlying Asset"><Select value={form.underlying} onChange={f('underlying')}><option value="BTC">BTC/USDT</option><option value="ETH">ETH/USDT</option></Select></Field>
                        <Field label="Notional Amount (USDT)"><Input type="number" value={form.notional} onChange={f('notional')} step="1000"/></Field>
                        <Field label="Tenor" hint="Maturity = Trade Date + tenor">
                            <Select value={form.maturityMonths} onChange={e=>setForm(p=>({...p,maturityMonths:parseInt(e.target.value)}))}>
                                <option value={1}>1 month</option>
                                <option value={2}>2 months</option>
                                <option value={3}>3 months</option>
                                <option value={6}>6 months</option>
                                <option value={12}>12 months</option>
                            </Select>
                        </Field>
                    </div>
                </div>

                {/* Participation Parameters */}
                <div>
                    <p className="text-xs font-semibold text-slate-400 uppercase tracking-wider mb-3">Participation Parameters</p>
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-3">
                        <Field label="Underlying Perf. Trigger (%)" hint="DoD change at or below this triggers scaling"><Input type="number" value={form.trigger*100} onChange={e=>setForm(p=>({...p,trigger:parseFloat(e.target.value)/100}))} step="0.1" placeholder="-3.0"/></Field>
                        <Field label="Participation Scaling Factor" hint="Multiplier applied when trigger is hit"><Input type="number" value={form.scalingFactor} onChange={f('scalingFactor')} step="0.1" min="1"/></Field>
                        <Field label="Price Discount Factor (%)" hint="0% = full market price; >0% = discounted buy price"><Input type="number" value={form.discountFactor*100} onChange={e=>setForm(p=>({...p,discountFactor:parseFloat(e.target.value)/100}))} step="0.1" min="0" max="50"/></Field>
                    </div>
                </div>

                {/* Auto-computed preview */}
                {computed.tradeDate && (
                    <div className="bg-slate-900/80 border border-slate-700 rounded-lg p-4">
                        <p className="text-xs font-semibold text-slate-400 uppercase tracking-wider mb-3">Auto-Computed Terms</p>
                        <div className="grid grid-cols-2 md:grid-cols-3 gap-3 text-xs">
                            {[
                                ['Trade Date', fmtDate(computed.tradeDate)],
                                ['Participation Start', fmtDate(computed.participationStart)],
                                ['Maturity Date', fmtDate(computed.maturityDate)],
                                ['Tenor', `${computed.tenor} calendar days`],
                                ['Total Fixing Days', `${computed.fixingDays} days`],
                                ['Base Daily Notional', `$${fmt(computed.baseNotional,2)}`],
                                ['Scaled Notional (trigger)', `$${fmt(computed.baseNotional * form.scalingFactor,2)}`],
                                ['Max Fixing Days possible', `${computed.fixingDays}`],
                                ['Notional / (fixing days-2)', `$${fmt(computed.notional/(computed.fixingDays-2)||0,2)}`],
                            ].map(([k,v])=>(
                                <div key={k} className="card-inner p-2.5">
                                    <p className="text-slate-400">{k}</p>
                                    <p className="font-semibold mono text-cyan-300">{v}</p>
                                </div>
                            ))}
                        </div>
                    </div>
                )}
            </div>
            <div className="flex gap-2 mt-5">
                <button onClick={handleSave} className="btn-primary flex-1 px-4 py-2 rounded-lg font-semibold text-sm">Create Contract</button>
                <button onClick={onClose} className="btn-secondary px-4 py-2 rounded-lg text-sm">Cancel</button>
            </div>
        </Modal>
    );
};

// ─── SHARED MODAL ─────────────────────────────────────────────────────────────
const Modal = ({title, children, onClose, wide}) => (
    <div className="fixed inset-0 bg-black/80 flex items-start justify-center p-4 z-50 overflow-y-auto">
        <div className={`bg-slate-900 border border-slate-700 rounded-xl p-6 ${wide?'max-w-3xl':'max-w-md'} w-full my-8`}>
            <div className="flex justify-between items-center mb-5">
                <h2 className="text-lg font-bold">{title}</h2>
                <button onClick={onClose} className="p-1.5 rounded-lg btn-secondary"><Icon.X/></button>
            </div>
            {children}
        </div>
    </div>
);

// ═══════════════════════════════════════════════════════════════════════════════
// ROOT APP
// ═══════════════════════════════════════════════════════════════════════════════
const App = () => {
    const [tab, setTab] = useState('ssps');
    const [prices, setPrices] = useState({BTC:0, ETH:0});
    const [fetchingPrices, setFetchingPrices] = useState(false);

    const fetchPrices = useCallback(async () => {
        setFetchingPrices(true);
        try {
            const r = await fetch('https://api.coingecko.com/api/v3/simple/price?ids=bitcoin,ethereum&vs_currencies=usd');
            const d = await r.json();
            setPrices({BTC: d.bitcoin?.usd||0, ETH: d.ethereum?.usd||0});
        } catch(e) { console.error(e); }
        setFetchingPrices(false);
    }, []);

    useEffect(() => { fetchPrices(); const t = setInterval(fetchPrices,30000); return ()=>clearInterval(t); }, []);

    return (
        <div className="min-h-screen bg-gradient-to-br from-slate-950 via-slate-900 to-slate-950 text-white">
            <div className="max-w-7xl mx-auto px-4 md:px-6 py-6">
                {/* Header */}
                <div className="mb-6">
                    <h1 className="text-3xl font-bold gradient-text mb-1">Crypto Prime Broker</h1>
                    <p className="text-slate-500 text-sm">Internal Portfolio Management System</p>
                </div>

                {/* Price Ticker */}
                <PriceTicker prices={prices} fetchingPrices={fetchingPrices} onRefresh={fetchPrices}/>

                {/* Tab Bar */}
                <div className="flex gap-1 mb-6 border-b border-slate-800">
                    {[['loans','Securitised Loans'],['ssps','Smart Participation Swap']].map(([id,label])=>(
                        <button key={id} onClick={()=>setTab(id)} className={`px-4 py-2.5 text-sm font-medium transition-all ${tab===id?'tab-active':'tab-inactive'}`}>
                            {label}
                        </button>
                    ))}
                </div>

                {/* Tab Content */}
                {tab === 'loans' ? <LoanModule prices={prices}/> : <SSPSModule prices={prices} fetchingPrices={fetchingPrices}/>}
            </div>
        </div>
    );
};

ReactDOM.render(<App/>, document.getElementById('root'));
</script>
</body>
</html>
